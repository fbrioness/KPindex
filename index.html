<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gráfico del Índice K Planetario con Google Charts</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>
</head>
<body>
    <div id="planetary_k_index_chart" style="width: 550px; height: 515px;"></div>

    <script>
        google.charts.load('current', {packages: ['corechart', 'bar']});
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {
            $.getJSON('https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json', function(response) {
                // Eliminar el encabezado de la respuesta
                const data = response.slice(1);

                // Filtrar los datos para obtener solo los últimos 2 días (48 horas)
                const now = moment();
                const twoDaysAgo = now.clone().subtract(48, 'hours');
                const filteredData = data.filter(item => moment(item[0]).isBetween(twoDaysAgo, now));

                const dataTable = new google.visualization.DataTable();
                dataTable.addColumn('string', 'Tiempo');
                dataTable.addColumn('number', 'Índice Kp');
                dataTable.addColumn({type: 'string', role: 'style'});

                filteredData.forEach(item => {
                    const start = moment.tz(item[0], "America/Santiago");
                    const end = start.clone().add(3, 'hours');
                    const label = `${start.format('MMMM-DD HH:mm')} a ${end.format('HH:mm')}`;
                    const value = parseFloat(item[1]);
                    let color = '#92D050';
                    if (value >= 7) color = '#C80000';
                    else if (value >= 5) color = '#FF0000';
                    else if (value >= 4) color = '#FF9600';
                    else if (value >= 3) color = '#FFC800';
                    dataTable.addRow([label, value, `color: ${color}`]);
                });

                const options = {
                    title: 'Índice K Planetario Estimado (Últimas 48 horas)',
                    hAxis: {
                        title: 'Hora Local de Chile',
                        slantedText: true,
                        slantedTextAngle: 45
                    },
                    vAxis: {
                        title: 'Índice Kp',
                        minValue: 0,
                        maxValue: 9,
                        gridlines: {count: 10}
                    },
                    legend: {position: 'none'},
                    width: 550,
                    height: 515
                };

                const chart = new google.visualization.ColumnChart(document.getElementById('planetary_k_index_chart'));
                chart.draw(dataTable, options);
            });
        }
    </script>
</body>
</html>
